#!/bin/bash

# GitHub Copilot OAuth Device Flow Login
# Authenticates with GitHub and saves token to ~/.config/github-copilot/apps.json

set -euo pipefail

CONFIG_DIR="$HOME/.config/github-copilot"
CONFIG_FILE="$CONFIG_DIR/apps.json"
CLIENT_ID="Iv1.b507a08c87ecfe98"  # Official GitHub Copilot client ID

# Check dependencies
for cmd in curl jq; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "Error: $cmd is required but not installed."
        exit 1
    fi
done

echo "Starting GitHub Copilot authentication..."
echo

# Step 1: Request device code
device_response=$(curl -s -X POST "https://github.com/login/device/code" \
    -H "Accept: application/json" \
    -d "client_id=$CLIENT_ID&scope=read:user")

device_code=$(echo "$device_response" | jq -r '.device_code')
user_code=$(echo "$device_response" | jq -r '.user_code')
verification_uri=$(echo "$device_response" | jq -r '.verification_uri')
expires_in=$(echo "$device_response" | jq -r '.expires_in')
interval=$(echo "$device_response" | jq -r '.interval // 5')

if [ "$device_code" = "null" ] || [ -z "$device_code" ]; then
    echo "Error: Failed to get device code"
    echo "$device_response" | jq .
    exit 1
fi

# Step 2: Prompt user to authenticate
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  Open: $verification_uri"
echo "  Enter code: $user_code"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo
echo "Waiting for authorization (expires in ${expires_in}s)..."

# Try to open browser automatically
if command -v xdg-open &>/dev/null; then
    xdg-open "$verification_uri" 2>/dev/null &
elif command -v open &>/dev/null; then
    open "$verification_uri" 2>/dev/null &
fi

# Step 3: Poll for access token
access_token=""
while [ -z "$access_token" ] || [ "$access_token" = "null" ]; do
    sleep "$interval"
    
    token_response=$(curl -s -X POST "https://github.com/login/oauth/access_token" \
        -H "Accept: application/json" \
        -d "client_id=$CLIENT_ID&device_code=$device_code&grant_type=urn:ietf:params:oauth:grant-type:device_code")
    
    error=$(echo "$token_response" | jq -r '.error // empty')
    
    case "$error" in
        "authorization_pending")
            printf "."
            ;;
        "slow_down")
            interval=$((interval + 5))
            printf "."
            ;;
        "expired_token")
            echo
            echo "Error: Device code expired. Please try again."
            exit 1
            ;;
        "access_denied")
            echo
            echo "Error: Authorization denied by user."
            exit 1
            ;;
        "")
            access_token=$(echo "$token_response" | jq -r '.access_token')
            ;;
        *)
            echo
            echo "Error: $error"
            echo "$token_response" | jq .
            exit 1
            ;;
    esac
done

echo
echo "✓ Authorization successful!"

# Step 4: Save token to config file
mkdir -p "$CONFIG_DIR"

# Create apps.json structure (matching VS Code Copilot format)
cat > "$CONFIG_FILE" << EOF
{
  "github.com": {
    "oauth_token": "$access_token"
  }
}
EOF

chmod 600 "$CONFIG_FILE"

echo "✓ Token saved to $CONFIG_FILE"
echo
echo "You can now use copilot-usage to check your Copilot status."
